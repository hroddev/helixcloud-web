---
import { siteData } from "../siteData";

const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || "";
---

<script define:vars={{ recaptchaSiteKey }}>
    const script = document.createElement("script");
    script.src = `https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`;
    document.head.appendChild(script);
</script>

<section id="contact" class="py-16 md:py-24 relative overflow-hidden">
    <!-- Decorator -->
    <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[100px] -z-10"
    >
    </div>

    <div class="container mx-auto px-6 md:px-12 text-center">
        <h2 class="text-3xl md:text-5xl font-bold mb-6">
            Ready to <span class="text-gradient">Optimize?</span>
        </h2>
        <p class="text-gray-400 max-w-2xl mx-auto mb-12 text-lg">
            Whether you need a complete cloud migration, a DevOps pipeline
            overhaul, or a security audit, I'm ready to help you scale.
        </p>

        <div
            class="glass p-8 md:p-12 rounded-3xl max-w-3xl mx-auto border border-white/10 shadow-2xl"
        >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-white">
                        Get in Touch
                    </h3>
                    <div class="space-y-4">
                        <a
                            href={siteData.linkedinUrl}
                            target="_blank"
                            class="flex items-center gap-3 text-gray-300 hover:text-white transition-colors"
                        >
                            <svg
                                class="w-5 h-5 text-blue-500"
                                fill="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
                                ></path></svg
                            >
                            {siteData.linkedinHandle}
                        </a>
                    </div>
                </div>

                <form id="contact-form" class="space-y-4">
                    <div>
                        <label
                            for="name"
                            class="block text-sm font-medium text-gray-400 mb-1"
                            >Your Name</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="w-full bg-white/5 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-sans"
                            placeholder="John Doe"
                            required
                        />
                    </div>
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-400 mb-1"
                            >Your Email</label
                        >
                        <input
                            type="email"
                            id="email"
                            name="email"
                            class="w-full bg-white/5 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-sans"
                            placeholder="name@company.com"
                            required
                        />
                    </div>
                    <div>
                        <label
                            for="message"
                            class="block text-sm font-medium text-gray-400 mb-1"
                            >How can I help?</label
                        >
                        <textarea
                            id="message"
                            name="message"
                            rows="3"
                            class="w-full bg-white/5 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-sans"
                            placeholder="Tell me about your project..."
                            required></textarea>
                    </div>
                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-medium py-3 px-4 rounded-lg shadow-lg shadow-blue-900/20 transition-all hover:scale-[1.02]"
                    >
                        Send Message
                    </button>
                    <p id="form-status" class="text-center text-sm mt-2 hidden">
                    </p>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const statusMsg = document.getElementById("form-status");
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            // Get reCAPTCHA token
            // @ts-ignore
            if (typeof grecaptcha !== "undefined") {
                try {
                    // @ts-ignore
                    const token = await grecaptcha.execute(
                        (
                            document.querySelector(
                                'script[src*="recaptcha/api.js"]',
                            ) as HTMLScriptElement
                        )?.src.split("render=")[1],
                        { action: "submit" },
                    );
                    data.recaptchaToken = token;
                } catch (err) {
                    console.error("reCAPTCHA Error:", err);
                }
            }

            // UI Loading state
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML =
                    '<span class="animate-pulse">Sending...</span>';
            }

            try {
                const response = await fetch("/api/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    form.reset();
                    if (statusMsg) {
                        statusMsg.textContent =
                            "Message sent successfully! I'll get back to you soon.";
                        statusMsg.className =
                            "text-center text-sm mt-2 text-green-400 block";
                    }
                } else {
                    throw new Error("Failed to send");
                }
            } catch (error) {
                console.error("Error:", error);
                if (statusMsg) {
                    statusMsg.textContent =
                        "Something went wrong. Please try again or email me directly.";
                    statusMsg.className =
                        "text-center text-sm mt-2 text-red-400 block";
                }
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Send Message";
                }
            }
        });
    }
</script>
